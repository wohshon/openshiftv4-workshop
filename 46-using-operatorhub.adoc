[[using-operatorhub]]
= Operators and Operator Hub


In this lab you will learn how to use operatorhub and operators.

OpenShift 4 has a slimmer base, with the ability to easily extend it with Operators for both cluster services (networking, storage, logging) and applications (databases, message queues, source control) for your developers to build applications with.

OperatorHub is a feature built into your cluster to discover and install Operators on your cluster. OperatorHub is only available for cluster administrators. Once installed, these services are made available to users of the cluster through the Developer Catalog.

Within OperatorHub, you will find three sets of Operators available to you:

  - Red Hat Products - licensed software that is tested extensively on OpenShift 4.
  - Certified Partners - partners that have certified their applications for OpenShift and have established a mutual support SLA with Red Hat, in order to provide you with the best experience.
  - Community - a set of curated Operators built by the Kubernetes community and work well with the Operator Lifecycle Management software already installed on your cluster.

In this example, we're going to deploy a `etcd` cluster through the Operator framework in OpenShift 4. `etcd` is a distributed key-value store.

NOTE: The first part of the Lab that involves the installation of a Operator will be executed for you prior to this lab as it needs escalated access rights . You can still reference the steps to see the ease of installation. In the 2nd part of the lab, you will be installing a etcd cluster using the operator that has been provisioned.

=== Create a Project


Before you get started, create a project for what you're about to do with Couchbase.
You can either do it from the command line:

IMPORTANT: Please replace *Username* with your username

```
$ oc new-project operators-user01
Now using project "operators-user01" on server "{{API_URL}}"
```
or create from console


=== Installing an Operator

NOTE: This section is just for you to better understand how an `operator` can be installed. As you do not have the admin role, you will not be able to carry out the steps in this section.

- Installing your first Operator is best done through the user interface, but
can also be driven by the command line. Let's complete this section using the
web console:

- Open the OpenShift web console, and log-in.

- On the left-hand side menu select 'Catalog' --> 'OperatorHub':

image::ocp4-operator-hub.png[image]

NOTE: Only users with cluster admin privileges can see the Operator Hub interface.

- Search, or browse to the `etcd` Operator and select it by clicking on it.

- The description lays out the notable features of the Operator. Click `Install`
to deploy the Operator on to the cluster. It may take several moments after
clicking "Install" before the Subscription page shows up:

image::ocp4-operators-etcd.png[image]

- Select the etcd operator, accept the warning message that states this operator is a community supported component.

- Click `install` to proceed installation
 
image::ocp4-operators-etcd-install.png[image]

- On the next screen, select the options as listed on the image.

- `Installation Mode`
  - All namespaces on the cluster (default)

- `Update Channel`
  - clusterwide-alpha

- `Approval Strategy`
  - Automatic


image::ocp4-operators-etcd-subscribe.png[image]


- After a few moments, you will see the etcd operator listed under `Installed Operators` 
image::ocp-operators-etcd-installed.png[image]

The installation process involves "subscribing" to an Operator from the hub.
This subscription mechanism is how OpenShift learns about updates to the operator.
Operator creators may roll updates for their operators to handle things like
updates, enhancements, bug fixes, and other changes to the solution that the
operator deploys. There are a number of options that you need to be aware of
when deploying an Operator:

**Installation Mode**
Operators can be enabled for all Projects across the cluster or only within
specific namespaces. Not all Operators support each of these installation methods.
The Couchbase operator only supports installation for a specific namespace. Make
sure `mycouchbase-Username` is selected to match the project you created earlier.

**Update Channel**
Each Operator publisher can create channels for their software, to give
adminsitrators more control over the versions that are installed. In this case,
Couchbase only has a "preview" channel.

**Update Approval Strategy**
If Operator creators enable their operators to update the deployed solutions,
Operator Lifecycle Manager is able to automatically apply those updates. Cluster
administrators can decide whether or not OLM should or should not automatically
apply updates. In the future, when Couchbase releases an updated operator to the
"preview" channel, you can decide whether you want to approve each update, or
have it happen automatically. Choose "Automatic" for now.




=== Using an Installed Operator

Regular users will use the "Administrator" view to use the `operators` functions.

- Navigate to `Administrator` on the top left hand menu.

image::ocp4-role-dropdown.png[image]

- Choose `Operators` --> `Installed Operators` on the left hand menu

- Make sure you are in the correct project `operators-<Username>`, as indicated on the project drop-down at top of the screen

- You should see the etcd operator is available, and there are 3 APIs exposed for you to use to manage a etcd cluster. 
image::ocp4-operator-installed-operator.png[image]


- Click on the `etcd` tile (under the Name column), to see the detailed info of this operator.

- Click on the `Create Instance` under the `etcd Cluster` column to start deploying a etcd cluster.
 
image::ocp4-operators-details.png[image]

- You will be led to the page where a definition of the etcd cluster to be deployed is display (in YAML form).

- The YAML editor has been pre-filled with a set of defaults for the resulting cluster.

- You may change the values at this juncture should you need to, like updating the size of the cluster, version of etcd.

- For this lab, you may just clear on `Create` to proceed installing.


image::ocp4-operators-create-yaml.png


=== View the Deployed Resources

- After creating the cluster, you will be led to the overview page showing the status of the cluster you just deployed.

image::ocp4-operarots-created.png[image]

- Navigate to the Etcd Cluster that was deployed by clicking `example`
- Under the `Overview` tab, `Member Status` you may see the number of etcd nodes that are started (It may take a while for it to reach 3)
- You can click on the `Resources` tab to look at the the objects deployed by the Operator (Pods etc)
- You should see 3 pods created for etcd cluster
image::ocp4-operarots-created-1.png[image]

=== Optional exercise - interating with the etcd cluster

- You can test out the cluster you created by creating key value entries in them.
- e.g.: 
NOTE: `oc rsh` allows you to open a remote shell into the pods.

```
# oc project operators-user01
$ oc get pods
NAME                 READY   STATUS    RESTARTS   AGE
example-7x78p5rhz6   1/1     Running   0          24m
example-f4lx2bkkk7   1/1     Running   0          24m
example-hcntqx78jt   1/1     Running   0          24m
$ oc rsh example-7x78p5rhz6

~ $ etcdctl set hello world
world
~ $ etcdctl update hello world!!!
world!!!
~ $ etcdctl get hello
world!!!
~ $ exit

```
You can `oc rsh` into another pod and you can see that the value has been replicated across



=== Optional exercise - Re-Configure the Cluster with the Operator

- You can change the cluster configurations by going to the `YAML` tab and make modifications to the cluster.
- Some suggestions:

  - change the size to 1
  - change the version to 3.2.12
  - go back to the operator api to create a new cluster (you need to use a new name), be mindful that there may be restrictions on the total number of pods in your namespace when you spin up additional clusters


```
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdCluster
metadata:
  annotations:
    etcd.database.coreos.com/scope: clusterwide
  creationTimestamp: '2019-10-31T00:15:04Z'
  generation: 11
  name: example
  namespace: operators-user01
  resourceVersion: '2971222'
  selfLink: >-
    /apis/etcd.database.coreos.com/v1beta2/namespaces/operators-user01/etcdclusters/example
  uid: 7d01b459-fb73-11e9-acc0-0a16fd1df84c
spec:
  repository: quay.io/coreos/etcd
  size: 3
  version: 3.2.13
status:
  clientPort: 2379
  conditions:
    - lastTransitionTime: '2019-10-31T00:16:01Z'
      lastUpdateTime: '2019-10-31T00:16:01Z'
      reason: Cluster available
      status: 'True'
      type: Available
    - lastTransitionTime: '2019-10-31T00:49:58Z'
      lastUpdateTime: '2019-10-31T00:49:58Z'
      message: 'Current cluster size: 2, desired cluster size: 3'
      reason: Scaling up
      status: 'True'
      type: Scaling
  currentVersion: 3.2.13
  members:
    ready:
      - example-7x78p5rhz6
      - example-hcntqx78jt
  phase: Running
  serviceName: example-client
  size: 3
  targetVersion: ''
```

Congratulations!! You now know how to install operators and deploy application
via OperatorHub. From more information about operator, see
https://docs.openshift.com/container-platform/4.2/applications/operators/olm-what-operators-are.html for more details.
